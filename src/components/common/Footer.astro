---
import {
  MailIcon,
  MapPin,
  PhoneCallIcon,
  Send,
  Linkedin,
  Twitter,
  AlertCircle,
  CheckCircle2,
  Loader2,
} from "@lucide/astro";

const web3formsAccessKey = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;

if (!web3formsAccessKey && import.meta.env.DEV) {
  console.warn(
    "⚠️ Web3Forms access key not configured. Please set PUBLIC_WEB3FORMS_ACCESS_KEY in your .env file."
  );
}

const year = new Date().getFullYear();
---

<section id="contacto" class="py-20 md:py-32 bg-white">
  <div class="max-w-7xl mx-auto px-6 lg:px-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">
      <div>
        <h2
          class="text-3xl md:text-4xl text-slate-900 font-semibold tracking-tight mb-6"
        >
          Inicie la conversación
        </h2>
        <p class="text-slate-600 font-normal mb-10 max-w-md">
          Complete el formulario y uno de nuestros socios se pondrá en
          contacto con usted a la brevedad para discutir sus necesidades
          legales.
        </p>

        <div class="space-y-6">
          <div class="flex items-center gap-4 group">
            <div
              class="w-10 h-10 flex items-center justify-center border border-slate-200 rounded-none group-hover:border-red-200 transition-colors"
            >
              <MapPin
                width="20"
                stroke-width="1.5"
                class="text-slate-500 group-hover:text-red-700"
              />
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-900">
                Oficina Principal
              </p>
              <p class="text-sm text-slate-500 font-normal">
                San Isidro, Lima - Perú
              </p>
            </div>
          </div>
          <div class="flex items-center gap-4 group">
            <div
              class="w-10 h-10 flex items-center justify-center border border-slate-200 rounded-none group-hover:border-red-200 transition-colors"
            >
              <PhoneCallIcon
                width="20"
                stroke-width="1.5"
                class="text-slate-500 group-hover:text-red-700"
              />
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-900">Teléfono</p>
              <p class="text-sm text-slate-500 font-normal">+51 1 234 5678</p>
            </div>
          </div>
          <div class="flex items-center gap-4 group">
            <div
              class="w-10 h-10 flex items-center justify-center border border-slate-200 rounded-none group-hover:border-red-200 transition-colors"
            >
              <MailIcon
                width="20"
                stroke-width="1.5"
                class="text-slate-500 group-hover:text-red-700"
              />
            </div>
            <div>
              <p class="text-sm font-semibold text-slate-900">Email</p>
              <p class="text-sm text-slate-500 font-normal">
                contacto@retorna.com
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-slate-50 p-8 md:p-12 border border-slate-100">
        <div
          id="success-message"
          class="hidden mb-6 p-4 bg-green-50 border border-green-200 text-green-800"
        >
          <div class="flex items-start gap-3">
            <CheckCircle2
              width="20"
              stroke-width="1.5"
              class="text-green-600 mt-0.5 shrink-0"
            />
            <div>
              <p class="font-semibold text-sm">¡Mensaje enviado exitosamente!</p>
              <p class="text-xs mt-1">
                Nos pondremos en contacto con usted a la brevedad.
              </p>
            </div>
          </div>
        </div>

        <div
          id="error-message"
          class="hidden mb-6 p-4 bg-red-50 border border-red-200 text-red-800"
        >
          <div class="flex items-start gap-3">
            <AlertCircle
              width="20"
              stroke-width="1.5"
              class="text-red-600 mt-0.5 shrink-0"
            />
            <div>
              <p class="font-semibold text-sm">Error al enviar el mensaje</p>
              <p class="text-xs mt-1" id="error-text">
                Por favor, intente nuevamente.
              </p>
            </div>
          </div>
        </div>

        <form id="contact-form" class="space-y-6" novalidate>
          <input
            type="hidden"
            name="access_key"
            value={web3formsAccessKey}
          />
          <input type="checkbox" name="botcheck" class="hidden" />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2">
              <label
                for="name"
                class="text-xs font-semibold uppercase tracking-wider text-slate-500"
              >
                Nombre <span class="text-red-600">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                minlength="2"
                maxlength="100"
                class="w-full bg-white border-b border-slate-300 px-0 py-2 focus:outline-none focus:border-red-700 transition-colors text-slate-900 placeholder-slate-300 text-sm"
                placeholder="Su nombre completo"
              />
              <p class="text-xs text-red-600 hidden" data-error="name">
                Por favor, ingrese su nombre completo (mínimo 2 caracteres)
              </p>
            </div>
            <div class="space-y-2">
              <label
                for="email"
                class="text-xs font-semibold uppercase tracking-wider text-slate-500"
              >
                Email Corporativo <span class="text-red-600">*</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                class="w-full bg-white border-b border-slate-300 px-0 py-2 focus:outline-none focus:border-red-700 transition-colors text-slate-900 placeholder-slate-300 text-sm"
                placeholder="correo@empresa.com"
              />
              <p class="text-xs text-red-600 hidden" data-error="email">
                Por favor, ingrese un correo electrónico válido
              </p>
            </div>
          </div>

          <div class="space-y-2">
            <label
              for="company"
              class="text-xs font-semibold uppercase tracking-wider text-slate-500"
            >
              Empresa / Organización
            </label>
            <input
              type="text"
              id="company"
              name="company"
              maxlength="100"
              class="w-full bg-white border-b border-slate-300 px-0 py-2 focus:outline-none focus:border-red-700 transition-colors text-slate-900 placeholder-slate-300 text-sm"
              placeholder="Nombre de su organización"
            />
          </div>

          <div class="space-y-2">
            <label
              for="message"
              class="text-xs font-semibold uppercase tracking-wider text-slate-500"
            >
              Mensaje <span class="text-red-600">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              rows="4"
              required
              minlength="10"
              maxlength="1000"
              class="w-full bg-white border-b border-slate-300 px-0 py-2 focus:outline-none focus:border-red-700 transition-colors text-slate-900 placeholder-slate-300 text-sm resize-none"
              placeholder="Breve descripción de su consulta..."></textarea>
            <p class="text-xs text-red-600 hidden" data-error="message">
              Por favor, ingrese un mensaje (mínimo 10 caracteres)
            </p>
          </div>

          <div class="pt-4">
            <button
              type="submit"
              id="submit-btn"
              class="group inline-flex items-center justify-center w-full md:w-auto px-8 py-3 bg-slate-900 text-white text-sm font-semibold hover:bg-red-800 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-slate-900"
            >
              <span id="btn-text">Enviar Mensaje</span>
              <Loader2
                width="16"
                stroke-width="1.5"
                class="ml-2 hidden animate-spin"
                id="btn-loader"
              />
              <Send
                width="16"
                stroke-width="1.5"
                class="ml-2 group-hover:translate-x-1 transition-transform"
                id="btn-icon"
              />
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<footer class="bg-slate-900 text-white py-12 border-t border-slate-800">
  <div class="max-w-7xl mx-auto px-6 lg:px-12">
    <div
      class="flex flex-col md:flex-row justify-between items-start md:items-center gap-8 mb-12"
    >
      <div>
        <span
          class="font-sans text-2xl tracking-tighter font-semibold text-white block mb-1"
          >RETORNA</span
        >
        <span class="text-[0.60rem] uppercase tracking-[0.2em] text-slate-400"
          >Inversiones Público-Privadas</span
        >
      </div>
      <div class="flex gap-6">
        <a href="#" class="text-slate-400 hover:text-white transition-colors">
          <Linkedin width="24" stroke-width="1.5" />
        </a>
        <a href="#" class="text-slate-400 hover:text-white transition-colors">
          <Twitter width="24" stroke-width="1.5" />
        </a>
      </div>
    </div>

    <div
      class="flex flex-col md:flex-row justify-between items-center pt-8 border-t border-slate-800 text-xs text-slate-500 font-normal"
    >
      <p>
        © {year} Retorna Inversiones Público-Privadas. Todos los derechos
        reservados.
      </p>
      <div class="flex gap-6 mt-4 md:mt-0">
        <a href="#" class="hover:text-white transition-colors"
          >Política de Privacidad</a
        >
        <a href="#" class="hover:text-white transition-colors"
          >Términos de Uso</a
        >
      </div>
    </div>
  </div>
</footer>

<script>
  function initContactForm() {
    const form = document.getElementById(
      "contact-form"
    ) as HTMLFormElement | null;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement | null;
    const btnText = document.getElementById("btn-text");
    const btnLoader = document.getElementById("btn-loader");
    const btnIcon = document.getElementById("btn-icon");
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");
    const errorText = document.getElementById("error-text");

    if (!form || !submitBtn) return;

    const inputs = form.querySelectorAll("input, textarea");
    inputs.forEach((input) => {
      const htmlInput = input as HTMLInputElement | HTMLTextAreaElement;
      
      htmlInput.addEventListener("blur", () => {
        validateField(htmlInput);
      });

      htmlInput.addEventListener("input", () => {
        const errorEl = form.querySelector(
          `[data-error="${htmlInput.id}"]`
        ) as HTMLElement;
        if (errorEl) {
          errorEl.classList.add("hidden");
          htmlInput.classList.remove("border-red-500");
        }
      });
    });

    function validateField(field: HTMLInputElement | HTMLTextAreaElement): boolean {
      const errorEl = form?.querySelector(
        `[data-error="${field.id}"]`
      ) as HTMLElement | null;
      
      if (!field.checkValidity()) {
        if (errorEl) {
          errorEl.classList.remove("hidden");
          field.classList.add("border-red-500");
        }
        return false;
      } else {
        if (errorEl) {
          errorEl.classList.add("hidden");
          field.classList.remove("border-red-500");
        }
        return true;
      }
    }

    function validateForm(): boolean {
      let isValid = true;
      const requiredFields = form?.querySelectorAll(
        "[required]"
      ) as NodeListOf<HTMLInputElement | HTMLTextAreaElement>;

      requiredFields.forEach((field) => {
        if (!validateField(field)) {
          isValid = false;
        }
      });

      return isValid;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      successMessage?.classList.add("hidden");
      errorMessage?.classList.add("hidden");

      if (!validateForm()) {
        const firstError = form.querySelector(".border-red-500");
        firstError?.scrollIntoView({ behavior: "smooth", block: "center" });
        return;
      }

      const formData = new FormData(form);
      const accessKey = formData.get("access_key");
      
      if (!accessKey || accessKey === "") {
        errorMessage?.classList.remove("hidden");
        if (errorText) {
          errorText.textContent = "Error de configuración: API key no encontrada. Contacte al administrador.";
        }
        errorMessage?.scrollIntoView({ behavior: "smooth", block: "center" });
        console.error("❌ Web3Forms access key is not configured. Please set PUBLIC_WEB3FORMS_ACCESS_KEY in your .env file.");
        return;
      }

      submitBtn.disabled = true;
      if (btnText) btnText.textContent = "Enviando...";
      btnIcon?.classList.add("hidden");
      btnLoader?.classList.remove("hidden");

      try {
        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          body: formData,
        });

        const data = await response.json();

        if (data.success) {
          successMessage?.classList.remove("hidden");
          successMessage?.scrollIntoView({ behavior: "smooth", block: "center" });
          
          form.reset();
          
          setTimeout(() => {
            successMessage?.classList.add("hidden");
          }, 8000);
        } else {
          throw new Error(data.message || "Error al enviar el formulario");
        }
      } catch (error) {
        errorMessage?.classList.remove("hidden");
        if (errorText && error instanceof Error) {
          errorText.textContent = error.message || "Por favor, intente nuevamente.";
        }
        errorMessage?.scrollIntoView({ behavior: "smooth", block: "center" });
        
        setTimeout(() => {
          errorMessage?.classList.add("hidden");
        }, 8000);
      } finally {
        submitBtn.disabled = false;
        if (btnText) btnText.textContent = "Enviar Mensaje";
        btnIcon?.classList.remove("hidden");
        btnLoader?.classList.add("hidden");
      }
    });
  }

  initContactForm();

  document.addEventListener("astro:page-load", initContactForm);
</script>

<style>
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }
</style>
